name: Build and Push testops container image

on:
  push:
    branches:
      - 'main'
      - 'stable'
      - 'stable-2.x'
    paths:
      - 'Dockerfile.testops'
      - 'clients/python/**'
      - 'api/**'
      - 'manifests/**'
      - 'scripts/**'
      - '!LICENSE*'
      - '!**.gitignore'
      - '!**.md'
      - '!**.txt'
      - '.github/workflows/build-and-push-testops-image.yml' # self

permissions: # set contents: read at top-level, per OpenSSF ScoreCard rule TokenPermissionsID
  contents: read

env:
  IMG_REGISTRY: quay.io
  IMG_ORG: opendatahub
  IMG_NAME: model-registry-testops
  REGISTRY_USER: ${{ secrets.QUAY_USERNAME }}
  REGISTRY_PWD: ${{ secrets.QUAY_PASSWORD }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: github.repository == 'opendatahub-io/model-registry'
    permissions:
      contents: read
      packages: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5.0.0

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to the Container registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.IMG_REGISTRY }}
        username: ${{ env.REGISTRY_USER }}
        password: ${{ env.REGISTRY_PWD }}

    - name: Set branch-based environment
      run: |
        commit_sha=${{ github.sha }}
        branch_name=${GITHUB_REF#refs/heads/}
        tag=${branch_name}-${commit_sha:0:7}
        # Calculate expiration date (7 days from now)
        expiry_date=$(date -d '+7 days' -u +%Y-%m-%dT%H:%M:%SZ)
        
        echo "VERSION=${tag}" >> $GITHUB_ENV
        echo "BRANCH_NAME=${branch_name}" >> $GITHUB_ENV
        echo "EXPIRY_DATE=${expiry_date}" >> $GITHUB_ENV

    - name: Set tag environment # this is for v* tag image build
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        echo "VERSION=${{ github.ref_name }}" >> $GITHUB_ENV

    - name: Build and push SHA-based image (expires in 7 days)
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile.testops
        push: true
        tags: |
          ${{ env.IMG_REGISTRY }}/${{ env.IMG_ORG }}/${{ env.IMG_NAME }}:${{ env.VERSION }}
        labels: |
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.created=${{ github.event.repository.updated_at }}
          quay.expires-after=7d
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: mode=max
        sbom: true

    - name: Build and push persistent branch tags (main)
      if: github.ref == 'refs/heads/main'
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile.testops
        push: true
        tags: |
          ${{ env.IMG_REGISTRY }}/${{ env.IMG_ORG }}/${{ env.IMG_NAME }}:${{ env.BRANCH_NAME }}
          ${{ env.IMG_REGISTRY }}/${{ env.IMG_ORG }}/${{ env.IMG_NAME }}:latest
        labels: |
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.created=${{ github.event.repository.updated_at }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: mode=max
        sbom: true

    - name: Build and push persistent branch tags (non-main)
      if: github.ref != 'refs/heads/main'
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile.testops
        push: true
        tags: |
          ${{ env.IMG_REGISTRY }}/${{ env.IMG_ORG }}/${{ env.IMG_NAME }}:${{ env.BRANCH_NAME }}
        labels: |
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.created=${{ github.event.repository.updated_at }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: mode=max
        sbom: true
